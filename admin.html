<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bryce Beene - Admin Panel</title>
    <!-- Use the Inter and Lora fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f0e5;
            color: #0b2447;
        }

        .container {
            max-width: 80rem;
        }

        .section-title {
            position: relative;
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
            font-family: 'Lora', serif;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 4rem;
            height: 4px;
            background-color: #576f72;
            border-radius: 9999px;
        }

        .text-accent {
            color: #576f72;
        }

        .bg-primary {
            background-color: #0b2447;
        }

        .bg-secondary {
            background-color: #f8f0e5;
        }

        .bg-accent {
            background-color: #576f72;
        }

        .font-headline {
            font-family: 'Lora', serif;
        }
    </style>
</head>

<body>

    <nav class="bg-primary sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center text-white">
            <a href="#" class="text-2xl font-bold font-headline tracking-widest text-white">BRYCE BEENE - ADMIN</a>
            <div class="flex space-x-4">
                <a href="#emails"
                    class="px-3 py-2 hover:text-accent transition-colors duration-300 rounded-full">Emails</a>
                <a href="#epk" class="px-3 py-2 hover:text-accent transition-colors duration-300 rounded-full">EPK
                    Password</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-16 sm:px-12">
        <section id="emails" class="mb-16">
            <h2 class="text-3xl font-bold section-title mb-8">Subscriber Emails</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div id="email-list" class="space-y-4">
                    <p class="text-gray-500 italic">Loading emails...</p>
                </div>
            </div>
        </section>

        <section id="epk" class="mb-16">
            <h2 class="text-3xl font-bold section-title mb-8">EPK Password Management</h2>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="mb-4">
                    <p class="text-sm font-medium text-gray-700">Current Password:</p>
                    <p id="current-password" class="text-lg font-bold text-accent">***********</p>
                </div>

                <div class="space-y-4">
                    <h3 class="font-semibold text-lg">Change Password</h3>
                    <input type="password" id="new-password-input" placeholder="Enter new password"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent transition-colors duration-300">
                    <button id="update-password-button"
                        class="bg-accent text-white px-6 py-2 rounded-full font-semibold hover:bg-accent/80 transition-colors duration-300">Update
                        Password</button>
                    <p id="password-message" class="mt-2 text-sm font-semibold text-green-700 hidden"></p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-primary text-white py-6 mt-16 text-center">
        <p>&copy; 2025 Bryce Beene. Admin Panel.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.onload = function () {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

            let app, db, auth;
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                return;
            }

            // Function to hash a string using SHA-256
            async function hashString(str) {
                const encoder = new TextEncoder();
                const data = encoder.encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            }

            // Real-time listener for the emails
            async function setupEmailListener() {
                try {
                    await signInAnonymously(auth);
                    const emailsCollection = collection(db, `/artifacts/${appId}/public/data/newsletter_emails`);

                    onSnapshot(emailsCollection, (snapshot) => {
                        const emailListDiv = document.getElementById('email-list');
                        emailListDiv.innerHTML = ''; // Clear previous emails
                        if (snapshot.empty) {
                            emailListDiv.innerHTML = '<p class="text-gray-500 italic">No subscribers yet.</p>';
                        } else {
                            snapshot.forEach((doc) => {
                                const emailData = doc.data();
                                const emailElement = document.createElement('div');
                                emailElement.className = 'bg-gray-100 p-3 rounded-md shadow-sm';
                                emailElement.textContent = emailData.email;
                                emailListDiv.appendChild(emailElement);
                            });
                        }
                    }, (error) => {
                        console.error("Error fetching emails:", error);
                        document.getElementById('email-list').innerHTML = '<p class="text-red-500">Error loading emails.</p>';
                    });
                } catch (error) {
                    console.error("Authentication Error:", error);
                    document.getElementById('email-list').innerHTML = '<p class="text-red-500">Could not authenticate. Check your Firebase setup.</p>';
                }
            }

            // Function to update the password
            async function updatePassword() {
                const newPasswordInput = document.getElementById('new-password-input');
                const passwordMessage = document.getElementById('password-message');
                const newPassword = newPasswordInput.value.trim();

                if (!newPassword) {
                    passwordMessage.textContent = 'Password cannot be empty.';
                    passwordMessage.classList.remove('hidden', 'text-green-700');
                    passwordMessage.classList.add('text-red-500');
                    return;
                }

                try {
                    await signInAnonymously(auth);
                    const hashedPassword = await hashString(newPassword);
                    const passwordDocRef = doc(db, `/artifacts/${appId}/public/data/epk/unreleased_password`);

                    await setDoc(passwordDocRef, { hash: hashedPassword }, { merge: true });

                    passwordMessage.textContent = 'Password updated successfully!';
                    passwordMessage.classList.remove('hidden', 'text-red-500');
                    passwordMessage.classList.add('text-green-700');
                    newPasswordInput.value = '';
                } catch (error) {
                    console.error("Error updating password:", error);
                    passwordMessage.textContent = 'Error updating password. Please try again.';
                    passwordMessage.classList.remove('hidden', 'text-green-700');
                    passwordMessage.classList.add('text-red-500');
                }
            }

            // Attach event listeners
            document.getElementById('update-password-button').addEventListener('click', updatePassword);

            // Initial setup
            setupEmailListener();
        };
    </script>
</body>

</html>